---
- name: Update APT package index on Debian server using su to root and force reboot
  hosts: all
  become: yes
  become_method: su  # Use 'su' to switch to root
  become_user: root  # Become the root user
  tasks:
    - name: Run apt-get update as root
      apt:
        update_cache: yes
        cache_valid_time: 3600
      register: apt_update  # Register output to check later

    - name: Wait before rebooting to ensure updates are complete
      pause:
        seconds: 10  # Wait for 10 seconds before rebooting

    - name: Force reboot the server after update
      reboot:
        msg: "Force rebooting after apt-get update"
        reboot_timeout: 600
        connect_timeout: 5  # Time before retrying connection after reboot
        force: yes  # Force the reboot even if processes are running

    - name: Wait for the server to come back up
      wait_for:
        port: 22
        timeout: 300  # Wait for SSH to be available

    - name: Display system uptime
      command: uptime
      register: uptime_output

    - name: Print uptime on console
      debug:
        msg: "Uptime: {{ uptime_output.stdout }}"
